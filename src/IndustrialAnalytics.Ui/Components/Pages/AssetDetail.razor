@page "/assets/{AssetId}"
@using IndustrialAnalytics.Contracts.Insights
@using IndustrialAnalytics.Ui.Components.Shared
@inject IndustrialAnalytics.Ui.Services.InsightsApiClient Api

<h3>Asset: @AssetId</h3>

<div class="row g-3 align-items-end mb-3">
    <div class="col-md-4">
        <label class="form-label">From (UTC)</label>
        <input class="form-control" type="datetime-local" @bind="_from" />
    </div>

    <div class="col-md-4">
        <label class="form-label">To (UTC)</label>
        <input class="form-control" type="datetime-local" @bind="_to" />
    </div>

    <div class="col-md-4">
        <button class="btn btn-primary" @onclick="Reload" disabled="@_loading">
            Reload
        </button>
    </div>
</div>

@if (_loading)
{
    <p>Loading...</p>
}
else
{
    <h4>Summary</h4>
    @if (_summary is null)
    {
        <p>No summary.</p>
    }
    else
    {
        <div class="card p-3 mb-3">
            <div>
                <b>Risk:</b>
                <span class="@RiskBadgeClass(_summary.Risk.Level)">
                    ● @_summary.Risk.Level (@_summary.Risk.Score)
                </span>
            </div>
            <div><b>Failure mode:</b> @_summary.Risk.FailureMode</div>
            <div><b>Top drivers:</b> @_summary.Risk.TopDrivers</div>
            <div><b>As of:</b> @_summary.AsOfMinuteTs</div>
        </div>
    }
    <div class="card p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">AI Insight</h5>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" @onclick="RegenerateInsight" disabled="@_insightLoading">
                    Regenerate
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="CancelInsight" disabled="@(!_insightLoading)">
                    Cancel
                </button>
            </div>
        </div>

        @if (_insightLoading)
        {
            <div class="mt-2">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Generating insight… (page is ready)
            </div>
        }
        else if (!string.IsNullOrWhiteSpace(_insightError))
        {
            <div class="alert alert-warning mt-2 mb-0">@_insightError</div>
        }
        else if (_insight is not null)
        {
            <div class="mt-2">
                <div class="fw-semibold">@_insight.Headline</div>
                <div class="text-muted">@_insight.Summary</div>

                @if (_insight.LikelyCauses?.Count > 0)
                {
                    <div class="mt-2">
                        <div class="fw-semibold">Likely drivers</div>
                        <ul class="mb-0">
                            @foreach (var c in _insight.LikelyCauses)
                            {
                                <li>@c</li>
                            }
                        </ul>
                    </div>
                }

                @if (_insight.RecommendedNextSteps?.Count > 0)
                {
                    <div class="mt-2">
                        <div class="fw-semibold">Next steps</div>
                        <ol class="mb-0">
                            @foreach (var s in _insight.RecommendedNextSteps)
                            {
                                <li>@s</li>
                            }
                        </ol>
                    </div>
                }

                <div class="mt-2 small text-muted">@_insight.Disclaimer</div>
            </div>
        }
    </div>
    <h4>Risk trend</h4>

    @if (_risk is null || _risk.Count == 0)
    {
        <p>No risk points in range.</p>
    }
    else
    {
        <RiskSparkline Points="_risk" AnomalyTimesUtc="_anomalyTimes" />



        <div class="mt-2">
            <b>Current risk:</b>
            <RiskBadge Score="@_risk.Last().Score" />
        </div>
    }
    <h4>Risk points</h4>
    @if (_risk is null || _risk.Count == 0)
    {
        <p>No risk points in range.</p>
    }
    else
    {
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Time (UTC)</th>
                    <th>Risk</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in _risk)
                {
                    <tr>
                        <td>@p.MinuteTs</td>
                        <td>@p.Score</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <h4>Recommendations (OPEN)</h4>
    @if (_recs?.Items is null || _recs.Items.Count == 0)
    {
        <p>No open recommendations.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Title</th>
                    <th>Confidence</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in _recs.Items)
                {
                    <tr>
                        <td>@r.RecType</td>
                        <td>@r.Title</td>
                        <td>@r.Confidence</td>
                        <td>@r.Status</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-success me-2"
                                    @onclick="() => Ack(r.RecommendationId)">
                                ACK
                            </button>
                            <button class="btn btn-sm btn-outline-danger"
                                    @onclick="() => Close(r.RecommendationId)">
                                CLOSE
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }


}

@code {
    private AssetInsightDto? _insight;
    private bool _insightLoading;
    private string? _insightError;

    private CancellationTokenSource? _insightCts;
    private long _insightRunId;

    // ---- existing fields you already have ----
    private List<DateTime> _anomalyTimes = new();
    [Parameter] public string AssetId { get; set; } = "";
    private bool _loading = true;
    private IndustrialAnalytics.Contracts.Assets.AssetSummaryDto? _summary;
    private List<IndustrialAnalytics.Contracts.Risk.RiskPointDto>? _risk;
    private IndustrialAnalytics.Contracts.Assets.AssetRecommendationsResponseDto? _recs;
    private DateTime? _from = new DateTime(2025, 1, 1, 12, 0, 0, DateTimeKind.Utc);
    private DateTime? _to = new DateTime(2025, 1, 1, 18, 0, 0, DateTimeKind.Utc);
    private const string UserName = "blazor-ui";

    protected override async Task OnParametersSetAsync()
    {
        await Reload();     // load summary/risk/recs/anomalies only
        // do NOT start insight here
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // background kick-off (non-blocking)
            _ = StartInsightAsync(background: true);
        }
        return Task.CompletedTask;
    }

    // --- main entry point used by both initial load and regenerate ---
    private async Task StartInsightAsync(bool background)
    {
        CancelInsight(); // cancel prior run if any

        _insightRunId++;
        var runId = _insightRunId;

        _insightCts = new CancellationTokenSource();
        var ct = _insightCts.Token;

        _insightLoading = true;
        _insightError = null;

        // show spinner immediately
        await InvokeAsync(StateHasChanged);

        try
        {
            var fromUtc = DateTime.SpecifyKind((_from ?? DateTime.UtcNow.AddHours(-2)), DateTimeKind.Utc);
            var toUtc = DateTime.SpecifyKind((_to ?? DateTime.UtcNow), DateTimeKind.Utc);

            var dto = await Api.GetInsightAsync(AssetId, fromUtc, toUtc, take: 5, ct);

            // ignore stale completions
            if (runId != _insightRunId) return;

            _insight = dto;
            _insightError = dto is null ? "No insight returned." : null;
        }
        catch (OperationCanceledException)
        {
            if (runId != _insightRunId) return;
            _insightError = "Insight cancelled.";
        }
        catch (Exception ex)
        {
            if (runId != _insightRunId) return;
            _insightError = $"Insight failed: {ex.Message}";
        }
        finally
        {
            if (runId == _insightRunId)
            {
                _insightLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    // IMPORTANT: make this Task-returning so Blazor awaits it properly
    private Task RegenerateInsight() => StartInsightAsync(background: false);

    private void CancelInsight()
    {
        try
        {
            _insightCts?.Cancel();
        }
        catch { /* ignore */ }
        finally
        {
            _insightCts?.Dispose();
            _insightCts = null;
        }
    }


    private async Task ReloadCore()
    {
        _loading = true;

        // If user clears the input, fall back to last 2 hours
        var fromUtc = (_from ?? DateTime.UtcNow.AddHours(-2));
        var toUtc = (_to ?? DateTime.UtcNow);

        // Treat them as UTC (datetime-local has no TZ)
        fromUtc = DateTime.SpecifyKind(fromUtc, DateTimeKind.Utc);
        toUtc = DateTime.SpecifyKind(toUtc, DateTimeKind.Utc);

        _summary = await Api.GetAssetSummaryAsync(AssetId);
        _risk = (await Api.GetRiskSeriesAsync(AssetId, fromUtc, toUtc, stepMinutes: 1))?.ToList();
        _recs = await Api.GetRecommendationsAsync(AssetId, status: "OPEN", take: 50);

        var anomaliesResp = await Api.GetAnomaliesAsync(AssetId, fromUtc, toUtc);
        _anomalyTimes = anomaliesResp?.Items.Select(a => a.MinuteTs).ToList() ?? new();

        _loading = false;
    }
  
  
    private async Task Reload()
    {
        await ReloadCore();

        // optional: refresh insight after a reload
        //StartInsight();
    }
   


    private async Task Ack(long id)
    {
        await Api.AckRecommendationAsync(
            id,
            ackUntil: DateTime.UtcNow.AddHours(12),
            by: UserName,
            note: "Acked from Blazor UI");

        await Reload();
    }

    private async Task Close(long id)
    {
        await Api.CloseRecommendationAsync(
            id,
            reason: "Closed from Blazor UI",
            by: UserName);

        await Reload();
    }
    private static string RiskBadgeClass(string? level) =>
    (level ?? "").ToUpperInvariant() switch
    {
        "LOW" => "badge bg-success",
        "MED" or "MEDIUM" => "badge bg-warning text-dark",
        "HIGH" => "badge bg-danger",
        _ => "badge bg-secondary"
    };

}
